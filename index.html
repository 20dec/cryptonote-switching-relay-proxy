<!doctype html>
<html>
	<head>
		<title>CryptoKnight Proxy Mining Switch</title>
		<meta name="viewport" content="initial-scale=1, maximum-scale=1">
		<script src="/socket.io/socket.io.js"></script>
		<script src="//code.jquery.com/jquery-1.11.1.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.4.0/jquery.timeago.min.js"></script>
		
		<script>

			(function() {
				function getReadableHashRateString(hashrate){
				var i = 0;
				var byteUnits = [' H', ' KH', ' MH', ' GH', ' TH', ' PH' ];
				while (hashrate > 1000){
					hashrate = hashrate / 1000;
					i++;
				}
				return hashrate.toFixed(2) + byteUnits[i];
			}

			var docCookies = {
				getItem: function (sKey) {
					return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(sKey).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
				},
				setItem: function (sKey, sValue, vEnd, sPath, sDomain, bSecure) {
					if (!sKey || /^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
					var sExpires = "";
					if (vEnd) {
						switch (vEnd.constructor) {
							case Number:
								sExpires = vEnd === Infinity ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT" : "; max-age=" + vEnd;
								break;
							case String:
								sExpires = "; expires=" + vEnd;
								break;
							case Date:
								sExpires = "; expires=" + vEnd.toUTCString();
								break;
						}
					}
					document.cookie = encodeURIComponent(sKey) + "=" + encodeURIComponent(sValue) + sExpires + (sDomain ? "; domain=" + sDomain : "") + (sPath ? "; path=" + sPath : "") + (bSecure ? "; secure" : "");
					return true;
				},
				removeItem: function (sKey, sPath, sDomain) {
					if (!sKey || !this.hasItem(sKey)) { return false; }
					document.cookie = encodeURIComponent(sKey) + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT" + ( sDomain ? "; domain=" + sDomain : "") + ( sPath ? "; path=" + sPath : "");
					return true;
				},
				hasItem: function (sKey) {
					return (new RegExp("(?:^|;\\s*)" + encodeURIComponent(sKey).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=")).test(document.cookie);
				}
			};


			var socket;
			var user;
			var workerhashrate = 1;
			$(function () {

				$('#user').val(docCookies.getItem('login')||'');
				user = $('#user').val();

				$(document).ready(
					()=> {
					socket.emit('getruntimesettings', user);
					$('#userselector').change(
						()=> {
						user =  $('#userselector').val();
						$('#user').val(user);
						docCookies.setItem('login',user);
						$('#coins').empty();
						socket.emit('user',user);
						}
					);
					$("#uisettings :checkbox").change(function() {
						socket.emit('setruntimesetting',this.id.substr(6), this.checked)
						});
				});
			
				socket = io();

				socket.on('uiupdate', (update) => {
					if (update.coins) {
						let coins = update.coins;
						$('#coins').empty();
						$('#coins').append($(
							'<tr class="coin">' +
							'<td>Coin</td>' +
							'<td>Nethash</td>' +
							'<td>LastBlock</td>' +
							'<td>Difficulty</td>' +
							'<td>BTC Value</td>' +
							'<td>Daily Mined<br />(<span class="workerhashrate">1</span> kH/s)</td>' +
							'<td>Daily BTC<br />(<span class="workerhashrate">1</span> kH/s)</td>' +
							'<td>Pool</td>' +
							'</tr>'));

						for (var coin of coins) {
							$('#coins').append($(
								'<tr class="coin" id="row_' + coin.symbol + '">' +
								'<td class="swit" id="switch_' + (coin.symbol) + '">' + (coin.symbol) + '</td>' +
								'<td class="hashrate"></td>' +
								'<td class="netblock"></td>' +
								'<td class="difficulty"></td>' +
								'<td class="marketvalue"></td>' +
								'<td class="dailyearning"></td>' +
								'<td class="dailybtcearning"></td>' +
								'<td>' + (coin.url ? ('<a target="_blank" class="pool" href="' + coin.url.replace(/\/$/, "") + '/?wallet=' + coin.login + '">Poolstats</a>') : coin.login) + ' </td>' +
								'</tr>'));
							// if (coin.active)
							// 	$('#switch_' + coin.symbol).css('color', 'red');
							$('#switch_' + coin.symbol).click(function () {
								user = $('#user').val();
								socket.emit('switch', user, this.id.substr(7));
							});
						}
					};
					if (update.runtimesettings) {
						let runtimesettings = update.runtimesettings;
						$('#userselector').empty();
						runtimesettings.userList.map((user) => $("<option />", { text: user, value: user }).appendTo("#userselector"));
						$('#userselector').val($('#user').val());
						var uiSettings = Object.keys(runtimesettings.UIset);
						$("label.settinglabel").hide();
						uiSettings.map((settingId) => {
							$("label[for='UIset_" + settingId + "']").show();
							$("input#UIset_" + settingId).prop("checked", runtimesettings.UIset[settingId]);
						});
					}
					if (update.active) {
						let coin = update.active;
						$('.coin > .swit').css('color', 'white');
						$('#switch_' + coin).css('color', 'red');
					}
					if (update.workers) {
						$('#workers').empty();
						let list = update.workers.list;
						let servertime = update.workers.servertime;

						var combined=0;
						var keys = Object.keys(list);
						for(var worker of keys){
							if(worker == user) workerhashrate = list[worker].hashrate;
							var date = jQuery.timeago(new Date(list[worker].time * 1000));
							$('#workers').append($('<span>'+worker+' : '+date+' : '+list[worker].hashrate.toFixed(2)+' kH/s<br/></span>'));
							if(	list[worker].time > (servertime-(60*5))) combined+=list[worker].hashrate;
						}
						$('span.workerhashrate').text(workerhashrate.toFixed(1));
						$('#workers').append($('<span>combined : '+combined.toFixed(2)+' kH/s<br/></span>'));
					}
					if (update.coinsupdate) {
						CoinsToTable(update.coinsupdate);
					}

				});

				socket.on('usererror', (errorText) => {
					$("#userselector").val(null);
					alert(errorText);
				});

				$('#rel').click(function(){
					user =  $('#user').val();
					$('#coins').empty();
					socket.emit('reload',user);
				});
				$('#loaduser').click(function(){
					user =  $('#user').val();
					docCookies.setItem('login',user);
					$('#coins').empty();
					socket.emit('user',user);
				});

				function CoinsToTable(coins){
					for (var coin of coins) {
						//todo: get hashrate from worker
						let hashrate = 1;
						var seconds = new Date().getTime() / 1000;
						row = $("#row_" + coin.symbol);
						row.find( ".hashrate"    ).text(getReadableHashRateString(coin.network.difficulty / coin.network.coindifficultytarget) + '/sec');
						row.find( ".netblock"    ).text((seconds - coin.network.lastblockdatetime).toFixed(0)+'s');
						row.find( ".difficulty"  ).text(coin.network.difficulty);
						row.find( ".marketvalue" ).text(LimitFractionalDigits(coin.marketvalue));
						row.find( ".dailyearning").text(LimitFractionalDigits(coin.rewardperday  * (workerhashrate || 1)));
						row.find( ".dailybtcearning" ).text(LimitFractionalDigits(coin.rewardperday * coin.marketvalue * (workerhashrate || 1)));
					}
				}

				function LimitFractionalDigits(number, digits) {
					return isNaN(number) ? number : (parseFloat(number)).toFixed(Math.max((digits || 8) + 1 - (Math.max(number.toString().indexOf('.'), 1)),1));
				}
			});

			})();

		</script>
		
		<link rel="icon" href="favicon.ico" type="image/x-icon">
		<style type="text/css">

			#uisettings{
				clear:both;
				text-align: left;
			}
			label.settinglabel{
				font-size: 60%;
				display: none;
			}
			a{
				color:#ff0000;
				text-decoration:none;
				}
			a.pool {
				color:#0000ff !important;
				}
			a:hover{
				color:#000000;
				text-decoration:none;
				}
			.coin {
				text-align: left;
				font-size: 50%;
			}
			.workers {
				text-align: left;
				font-size: 50%;
			}
			.coin > td{
				font-size: 100%;
				padding:5px;
				line-height:1.5em;
			}
			.coin > .swit{
				cursor:pointer;
				background-color:blue;
				color:white;
			}
			#userselector {
				margin: 15px 10px;
			}
			.menu {
				margin:20px 10px;
				padding:0;
				}
			.menu > a{
				font-size:12px;
				font-weight:normal;
				text-align:center;
				display:block;
				background:#eeeeee;
				border:1px solid #dddddd;
				color:#000000;
				padding:10px;
				margin:10px 0;
				-moz-border-radius:2px;
				-webkit-border-radius:2px;
				border-radius:2px;
				-moz-box-shadow:0 2px 4px #aaaaaa;
				-webkit-box-shadow:0 2px 4px #aaaaaa;
				box-shadow:0 2px 4px #aaaaaa;
				}
			.menu > a:hover{
				color:#bbbbbb;
				-moz-box-shadow:none;
				-webkit-box-shadow:none;
				box-shadow:none;
				}
		</STYLE>
	</head>
	<body>

		<div style="text-align: center;font-size:2em;font-family:Consolas, Andale Mono, Lucida Console, Lucida Sans Typewriter, Monaco, Courier New, monospace">
			<select id='userselector' style='width: 25%; float:left;'></select>
			<input style="width: 60%;height: 100%; border-color: #ff0000 #0000ff; text-align: center;font-size:1em;font-family:Consolas, Andale Mono, Lucida Console, Lucida Sans Typewriter, Monaco, Courier New, monospace" id="user" type="text" value=""/>
			<div class="menu">
				<a id="loaduser" href="javascript:void(0);">Load</a>
				<div id='uisettings'>
					<label class="settinglabel" for="UIset_usePushMessaging">Use push messages
						<input id="UIset_usePushMessaging" type="checkbox">
					</label>
				</div>
			</div>

			<table id="coins"></table>

			<div class="menu">
				<a id="rel">Reload Config</a>
			</div>
			
			<div class="workers" id="workers"></div>
		</div>

	</body>
</html>

